#!/usr/bin/env bash
#set -x

LOGFILE="fugit.log"
CONFFILE="fugit.conf"
CONFDIR="$HOME/fugit.d"
CONF=$CONFFILE

contains_confdir(){
	[ -f $1 ] || return 1
	grep --fixed-strings --silent --line-regexp "$2" "$1"
	return $?
}

contains_conffile(){
	# temporarily disable pathname expansion to prevent expansion of $1
	set -f
	for entry in $1; do
		if [ "$entry" == "$2" ]; then
			set +f
			return 0
		fi
	done
	set +f
	return 1
}

check_acl(){
	# If using confdir, use confdir ACL
	if [ -d "$CONF" ]; then
		# Fix up the repository name
		REPONAME=$(echo $2 | tr '/' '_')
		#Read the config file
		eval "$CONF/$REPONAME.conf"
		if [ "$1" == "pull" ]; then
			contains_confdir "$PULL" "$3"
			return $?
		fi
		if [ "$1" == "push" ]; then
			contains_confdir "$PUSH" "$3"
			return $?
		fi
		return 1
	else
		# Use conffile syntax
		eval $(grep -Fx "REPO $2" $CONFFILE -A 3 | tail -n +2)
		if [ "$1" == "pull" ]; then
			contains_conffile "$PULL" "$3"
			return $?
		fi
		if [ "$1" == "push" ]; then
			contains_conffile "$PUSH" "$3"
			return $?
		fi
		return 1
	fi
	return 1
}

push(){
	#read repo config
	printf "%s %s: Trying to push to %s (Path %s)\n" "$(date)" "$FUGIT_USER" "$1" "$REAL" >> $LOGFILE
	if [ -z "$REAL" ]; then
		printf "%s %s: Unknown repo, abort\n" "$(date)" "$FUGIT_USER" >> $LOGFILE
		printf "FAIL"
		return 1
	fi

	#do access control
	if [ "$ACCEPT" == "1" ]; then
		git-receive-pack "$REAL"
		printf "%s %s: Push accepted\n" "$(date)" "$FUGIT_USER" >> $LOGFILE
	else
		printf "%s %s: Push rejected\n" "$(date)" "$FUGIT_USER" >> $LOGFILE
		printf "FAIL"
	fi
}

pull(){
	#read repo config
	printf "%s %s: Trying to read from %s (Path %s)\n" "$(date)" "$FUGIT_USER" "$1" "$REAL" >> $LOGFILE
	if [ -z "$REAL" ]; then
		printf "%s %s: Unknown repo, abort\n" "$(date)" "$FUGIT_USER" >> $LOGFILE
		printf "FAIL"
		return 1
	fi

	#do access control
	if [ "$ACCEPT" == "1" ]; then
		git-upload-pack "$REAL"
		printf "%s %s: Pull accepted\n" "$(date)" "$FUGIT_USER" >> $LOGFILE
	else
		printf "%s %s: Pull rejected\n" "$(date)" "$FUGIT_USER" >> $LOGFILE
		printf "FAIL"
	fi
}

ACCEPT=0
FUGIT_USER=$1
if [ -z "$FUGIT_USER" ]; then
	printf "%s UNKNOWN: No user name supplied\n" "$(date)" >> $LOGFILE
	exit 1
fi

printf "%s %s: Command is %s\n" "$(date)" "$FUGIT_USER" "$SSH_ORIGINAL_COMMAND" >> $LOGFILE
if [[ "$SSH_ORIGINAL_COMMAND" == "git-receive-pack "* ]]; then
	#extract argument
	REPO=${SSH_ORIGINAL_COMMAND#git-receive-pack }

	#remove quotes (without opening injection possibilities)
	REPO=$(echo $REPO | xargs echo)

	printf "%s %s: push to repo %s\n" "$(date)" "$FUGIT_USER" "$REPO" >> $LOGFILE

	check_acl "push" "$REPO" "$FUGIT_USER" && ACCEPT=1
	push "$REPO"
elif [[ "$SSH_ORIGINAL_COMMAND" == "git-upload-pack "* ]]; then
	#extract argument
	REPO=${SSH_ORIGINAL_COMMAND#git-upload-pack }

	#remove quotes (without opening injection possibilities)
	REPO=$(echo $REPO | xargs echo)

	printf "%s %s: pull from repo %s\n" "$(date)" "$FUGIT_USER" "$REPO" >> $LOGFILE

	check_acl "pull" "$REPO" "$FUGIT_USER" && ACCEPT=1
	pull "$REPO"
else
	printf "%s %s: Unknown command %s\n" "$(date)" "$FUGIT_USER" "$SSH_ORIGINAL_COMMAND" >> $LOGFILE
	exit 1
fi
